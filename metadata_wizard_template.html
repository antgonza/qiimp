{% import schema_builder %}
{% import metadata_package_schema_builder %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Metadata Wizard</title>
    <!-- bootstrap stylesheet -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">


    <style type="text/css">
        .fieldTemplate {
            display:none;
        }
        .floating {
        }
        .field {
            padding: 2px;
            border-top: 1px solid black;
        }
        .buttons {
            padding: 2px;
            border-top: 1px solid black;
        }
    </style>


    <!-- jquery -->
    <script src={{ static_url("third-party/jquery-3.2.1.min.js") }}></script>

    <!-- jquery validation plugin -->
    <script src={{ static_url("third-party/jquery_validation/jquery.validate.min.js") }}></script>
    <script src={{ static_url("third-party/jquery_validation/additional-methods.min.js") }}></script>

    <!-- bootstrap js -->
    <!-- <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script> -->

    <script src={{ static_url("third-party/js-yaml.min.js") }}></script>

    <script src={{ static_url("metadataWizardHelpers.js") }}></script>
    <script src={{ static_url("metadataWizardEventHandlers.js") }}></script>
    <script src={{ static_url("packageWizard.js") }}></script>
    <script src={{ static_url("metadataWizard.js") }}></script>


    <script type="text/javascript">
        g_reserved_word_url = "{{ static_url("reserved_words.yaml") }}";

        SEPARATOR = "{{schema_builder.SEPARATOR}}";
        TEMPLATE_SUFFIX = "{{schema_builder.TEMPLATE_SUFFIX}}";

        // Note that these are to be the bases (without template suffix or separator) of form element NAMES, not IDs
        SpecialInputs = {
            FIELD_NAME: "{{schema_builder.InputNames.field_name.value}}",
            FIELD_TYPE: "{{schema_builder.InputNames.field_type.value}}",
            ALLOWED_MISSINGS: "allowed_missing_vals_fieldset",
            DATA_TYPE: "{{schema_builder.InputNames.data_type.value}}",
            TRUE_VALUE: "{{schema_builder.InputNames.true_value.value}}",
            FALSE_VALUE: "{{schema_builder.InputNames.false_value.value}}",
            MINIMUM: "{{schema_builder.InputNames.minimum_value.value}}",
            MIN_COMPARE: "{{schema_builder.InputNames.minimum_comparison.value}}",
            MAXIMUM: "{{schema_builder.InputNames.maximum_value.value}}",
            MAX_COMPARE: "{{schema_builder.InputNames.maximum_comparison.value}}",
            CATEGORY_VALS: "{{schema_builder.InputNames.categorical_values.value}}",
            DEFAULT_MISSINGS: "{{schema_builder.InputNames.allowed_missing_default_select.value}}",
            DEFAULT_OPTION: "{{schema_builder.InputNames.default_value.value}}",
            DEFAULT_CATEGORICAL: "{{schema_builder.InputNames.categorical_default_select.value}}",
            DEFAULT_BOOLEAN: "{{schema_builder.InputNames.boolean_default_select.value}}",
            DEFAULT_CONTINUOUS: "{{schema_builder.InputNames.continuous_default.value}}",
            DEFAULT_TEXT: "{{schema_builder.InputNames.text_default.value}}",
            REMOVE_FIELD: "remove_field"
        };

        fields_to_show_by_field_type = {
            "":[],
            "{{schema_builder.FieldTypes.Text.value}}":["text_default_div"],
            "{{schema_builder.FieldTypes.Boolean.value}}": ["field_details_div","boolean_true_div", "boolean_false_div",
                "boolean_default_div"],
            "{{schema_builder.FieldTypes.Continuous.value}}": ["field_details_div","data_type_div", "minimum_div",
                "maximum_div", "units_div",
                "continuous_default_div"],
            "{{schema_builder.FieldTypes.Categorical.value}}": ["field_details_div","data_type_div", "categorical_div",
                "units_div", "categorical_default_div"]
        };

        function updateTypeValidation(base_name, field_index, data_type_value){
            // get the relevant input field and remove any existing validation rules related to data type (only)
            var input_id_selector = getIdSelectorFromBaseNameAndFieldIndex(base_name, field_index);
            $(input_id_selector).rules( "remove", "digits number" );

            // add back any required data type validation rule
            switch (data_type_value) {
                case "{{metadata_package_schema_builder.CerberusDataTypes.Integer.value}}":
                    $(input_id_selector).rules("add", {digits: true});
                    break;
                case "{{metadata_package_schema_builder.CerberusDataTypes.Decimal.value}}":
                    $(input_id_selector).rules("add", {number: true});
                    break;
                case "{{metadata_package_schema_builder.CerberusDataTypes.Text.value}}":
                    // no known validation required for text; perhaps length?
                    break;
                default:
                    alert("Unexpected data type value: '" + data_type_value + "'")
            }
        }

        function enableDisableDefaultSelects(field_index, curr_val){
            enableOrDisableByValue(SpecialInputs.DEFAULT_MISSINGS, field_index, curr_val,
                    "{{schema_builder.DefaultTypes.allowed_missing_default.value}}");
            enableOrDisableByValue(SpecialInputs.DEFAULT_CATEGORICAL, field_index, curr_val,
                    "{{schema_builder.DefaultTypes.categorical_default.value}}");
            enableOrDisableByValue(SpecialInputs.DEFAULT_BOOLEAN, field_index, curr_val,
                    "{{schema_builder.DefaultTypes.boolean_default.value}}");
            enableOrDisableByValue(SpecialInputs.DEFAULT_CONTINUOUS, field_index, curr_val,
                    "{{schema_builder.DefaultTypes.continuous_default.value}}");
            enableOrDisableByValue(SpecialInputs.DEFAULT_TEXT, field_index, curr_val,
                    "{{schema_builder.DefaultTypes.text_default.value}}");
        };
    </script>
</head>
<body>
<form id = "package_form">
    <div class="container" id="package_div">
        <div class="row" id="mode_div">
            <div class="col-sm-12">
                How would you like to select your metadata package?<br />
                <input type="radio" name="metadata_mode" id = "metadata_mode_wizard" value="wizard" onchange="onModeChange(this)" required>
                <label id="metadata_mode_wizard_label" for="metadata_mode_wizard">Use Wizard</label><br />
                <input type="radio" name="metadata_mode" id = "metadata_mode_power" value="power" onchange="onModeChange(this)">
                <label id="metadata_mode_power_label" for="metadata_mode_power">Select Manually</label>
            </div>
        </div>
        <div class="row hidden" id="power_div">
            <div class="col-sm-12">
                <label id="package_select_label" for="package_select">Metadata Packages:</label>
                <select name="package_select" id="package_select" disabled required>
                    <!-- TODO: refactor to pull from back end! -->
                    <option value="">--Select One--</option>
                    <!-- TODO: After Austin is done making packages, take out setting Generic to selected by default -->
                    <option value="other" selected="selected">Generic</option>
                </select>
            </div>
        </div>
        <div id="wizard_div" class="hidden">
            <div class="row" id="sample_type_div">
                <div class="col-sm-12">
                    <label id="sample_type_label" for="sample_type_select">Sample Type:</label>
                    <select name="sample_type_select" id="sample_type_select" onchange="onSampleTypeChange(this)" disabled required>
                        <!-- TODO: refactor to pull from back end! -->
                        <option value="">--Select One--</option>
                        <option value="stool">Stool</option>
                        <option value="mucus">Mucus</option>
                        <option value="seawater">Seawater</option>
                        <option value="other">Other</option>
                    </select>
                </div>
            </div>
            <div id="environmental_div" class="hidden"></div>
            <div id="host_associated_div" class="hidden">
                <div class="row" id="host_div">
                    <div class="col-sm-12">
                        <label id="host_select_label" for="host_select">Host Organism:</label>
                        <select name="host_select" id="host_select" onchange="checkSampleTypePlusHostImplications(this)" disabled required>
                            <!-- TODO: refactor to pull from back end! -->
                            <option value="">--Select One--</option>
                            <option value="human">Human</option>
                            <option value="mouse">Mouse</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
                <div class="row" id="host_specific_sample_type_div" >
                    <div class="col-sm-12">
                        <label id="host_sample_site_select_label" for="host_sample_site_select">Host Sample Site:</label>
                        <select name="host_sample_site_select" id="host_sample_site_select" disabled required>
                            <option value="">--Select One--</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <div class="row" id="select_package_button_div">
            <div class="col-sm-12">
                <input class="submit" type="submit" name="select_package_button" id="select_package_button"
                       value="Select Package" onsubmit="return getPackage()" disabled>
            </div>
        </div>
        <div class="row" id="package_details_div">
            <br />
            <br />
        </div>
    </div>
</form>
<form id ="metadata_form" method="post" action="" class="hidden">
    <div>
        <div class="container" id="container">
            <div class="row">
                <div class="col-sm-12">
                    <label for="{{schema_builder.InputNames.study_name.value}}">Study Name:</label>
                    <input id="{{schema_builder.InputNames.study_name.value}}" name = "{{schema_builder.InputNames.study_name.value}}" type="text" placeholder="Study name" />
                </div>
            </div>
            <div class="row">
                <div class="col-sm-12">
                    <!-- TODO: Locale is temporarily removed because it isn't implemented yet and isn't relevant to
                    Austin's set-up of supported packages
                    <label for="study_location_select">Study City/Locale:</label>
                    <select name="study_location_select" id="study_location_select" required>
                        <option value="">--Select One--</option>
                        <option value="san_diego">San Diego, CA, USA</option>
                        <option value="other">Other</option>
                    </select>
                    -->
                    <br />
                    Enter any custom fields for your experiment below:
                </div>
            </div>
            <div class="row fieldTemplate">
                <div class="col-sm-12">
                    <div class="row">
                        <div class="col-sm-4">
                            <div class="panel panel-default">
                                <div class="panel-heading">Field Name</div>
                                <div class="panel-body">
                                    <input placeholder="e.g., age" type="text" name="{{schema_builder.InputNames.field_name.value}}{{schema_builder.TEMPLATE_SUFFIX}}" id="{{schema_builder.InputNames.field_name.name}}_template" />
                                </div>
                            </div>
                            <div class="panel panel-default">
                                <div class="panel-heading">Field Type</div>
                                <div class="panel-body">
                                    <select name="{{schema_builder.InputNames.field_type.value}}{{schema_builder.TEMPLATE_SUFFIX}}" id="{{schema_builder.InputNames.field_type.name}}{{schema_builder.TEMPLATE_SUFFIX}}" >
                                        <option value="">--e.g., Categorical--</option>
                                        {% for curr_enum in schema_builder.FieldTypes %}
                                        <option value="{{curr_enum.value}}">{{curr_enum.name}}</option>
                                        {% end %}
                                    </select>
                                </div>
                            </div>
                            <div class="panel panel-default">
                                <div class="panel-heading">Field Description</div>
                                <div class="panel-body">
                                    <textarea placeholder="e.g., the age of the subject in years" name="field_desc{{schema_builder.TEMPLATE_SUFFIX}}" id="field_desc{{schema_builder.TEMPLATE_SUFFIX}}" ></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-4">
                            <fieldset class="initially_hidden hidden" id="field_details_div_template">
                                <div class="panel panel-default initially_hidden hidden" id="boolean_true_div_template">
                                    <div class="panel-heading">True Value</div>
                                    <div class="panel-body">
                                        <input type ="text" name="{{schema_builder.InputNames.true_value.value}}{{schema_builder.TEMPLATE_SUFFIX}}" id="{{schema_builder.InputNames.true_value.name}}{{schema_builder.TEMPLATE_SUFFIX}}" placeholder="e.g., Yes" disabled required/><br />
                                    </div>
                                </div>
                                <div class="panel panel-default initially_hidden hidden" id="boolean_false_div_template">
                                    <div class="panel-heading">False Value</div>
                                    <div class="panel-body">
                                        <input type ="text" name="{{schema_builder.InputNames.false_value.value}}{{schema_builder.TEMPLATE_SUFFIX}}" id="{{schema_builder.InputNames.false_value.name}}{{schema_builder.TEMPLATE_SUFFIX}}" placeholder="e.g., No" disabled required/><br />
                                    </div>
                                </div>
                                <div class = "panel panel-default initially_hidden hidden" id="data_type_div_template">
                                    <div class="panel-heading">Data Type</div>
                                    <div class="panel-body">
                                        <select name="{{schema_builder.InputNames.data_type.value}}{{schema_builder.TEMPLATE_SUFFIX}}" id="{{schema_builder.InputNames.data_type.name}}{{schema_builder.TEMPLATE_SUFFIX}}" disabled required>
                                            <option value="">--e.g., Integer--</option>
                                            {% for curr_enum in metadata_package_schema_builder.CerberusDataTypes %}
                                            <option value="{{curr_enum.value}}">{{curr_enum.name}}</option>
                                            {% end %}
                                        </select><br />
                                    </div>
                                </div>
                                <div class="panel panel-default initially_hidden hidden" id="categorical_div_template">
                                    <div class="panel-heading">Categorical Values (One Per Line)</div>
                                    <div class="panel-body">
                                        <textarea rows="5" cols="25" name="{{schema_builder.InputNames.categorical_values.value}}{{schema_builder.TEMPLATE_SUFFIX}}" id="{{schema_builder.InputNames.categorical_values.name}}{{schema_builder.TEMPLATE_SUFFIX}}" placeholder="e.g., Low&#10;Medium&#10;High" disabled required></textarea>
                                    </div>
                                </div>
                                <div class = "panel panel-default initially_hidden hidden" id="minimum_div_template">
                                    <div class="panel-heading">Minimum (Optional)</div>
                                    <div class="panel-body">
                                        <select name="{{schema_builder.InputNames.minimum_comparison.value}}{{schema_builder.TEMPLATE_SUFFIX}}" id="{{schema_builder.InputNames.minimum_comparison.name}}{{schema_builder.TEMPLATE_SUFFIX}}" disabled>
                                            <option value="">--e.g., Greater Than--</option>
                                            <option value="{{metadata_package_schema_builder.ValidationKeys.min_exclusive.value}}">Greater Than</option>
                                            <option value="{{metadata_package_schema_builder.ValidationKeys.min_inclusive.value}}">Greater Than Or Equal To</option>
                                        </select><br />
                                        <input type ="text" name="{{schema_builder.InputNames.minimum_value.value}}{{schema_builder.TEMPLATE_SUFFIX}}" id="{{schema_builder.InputNames.minimum_value.name}}{{schema_builder.TEMPLATE_SUFFIX}}" placeholder="e.g., 3"  disabled/>
                                    </div>
                                </div>
                                <div class="panel panel-default initially_hidden hidden" id="maximum_div_template">
                                    <div class="panel-heading">Maximum (Optional)</div>
                                    <div class="panel-body">
                                        <select name="{{schema_builder.InputNames.maximum_comparison.value}}{{schema_builder.TEMPLATE_SUFFIX}}" id="{{schema_builder.InputNames.maximum_comparison.name}}{{schema_builder.TEMPLATE_SUFFIX}}" disabled>
                                            <option value="">--e.g., Less Than--</option>
                                            <option value="{{metadata_package_schema_builder.ValidationKeys.max_exclusive.value}}">Less Than</option>
                                            <option value="{{metadata_package_schema_builder.ValidationKeys.max_inclusive.value}}">Less Than Or Equal To</option>
                                        </select><br />
                                        <input type ="text" name="{{schema_builder.InputNames.maximum_value.value}}{{schema_builder.TEMPLATE_SUFFIX}}" id="{{schema_builder.InputNames.maximum_value.name}}{{schema_builder.TEMPLATE_SUFFIX}}" placeholder="e.g, 10"  disabled/><br />
                                    </div>
                                </div>
                                <div class="panel panel-default initially_hidden hidden" id="units_div_template">
                                    <div class="panel-heading">Units (Optional)</div>
                                    <div class="panel-body">
                                        <input name="{{schema_builder.InputNames.units.value}}{{schema_builder.TEMPLATE_SUFFIX}}" id="{{schema_builder.InputNames.units.name}}{{schema_builder.TEMPLATE_SUFFIX}}" type="text" placeholder="e.g., years"  disabled/>
                                    </div>
                                </div>
                            </fieldset>
                        </div>
                        <div class="col-sm-4">
                            <div class="panel panel-default" id="allowed_missing_vals_div_template">
                                <div class="panel-heading">Allowed Missing Values (Optional)</div>
                                <div class="panel-body">
                                    <fieldset name="allowed_missing_vals_fieldset_template" id="allowed_missing_vals_fieldset_template">
                                        {% for curr_enum in metadata_package_schema_builder.EbiMissingValues %}
                                        <input type="checkbox" name="{{schema_builder.InputNames.allowed_missing_vals.value}}{{schema_builder.TEMPLATE_SUFFIX}}" id="{{schema_builder.InputNames.allowed_missing_vals.name}}_{{curr_enum.name}}{{schema_builder.TEMPLATE_SUFFIX}}" value="{{curr_enum.name}}"/> {{curr_enum.value}}<br />
                                        {% end %}
                                    </fieldset>
                                </div>
                            </div>
                            <div class="panel panel-default" id="default_div_template">
                                <div class="panel-heading">Default Value</div>
                                <div class="panel-body">
                                    <input type="radio" name="{{schema_builder.InputNames.default_value.value}}{{schema_builder.TEMPLATE_SUFFIX}}" id = "{{schema_builder.DefaultTypes.no_default.name}}{{schema_builder.TEMPLATE_SUFFIX}}" value="{{schema_builder.DefaultTypes.no_default.name}}" checked="checked">
                                    <label for="no_default_template">&nbsp;No Default</label><br />

                                    <div id="allowed_missing_default_div_template">
                                        <input type="radio" name="{{schema_builder.InputNames.default_value.value}}{{schema_builder.TEMPLATE_SUFFIX}}" id = "allowed_missing_default_template" value="allowed_missing_default">
                                        <label for="{{schema_builder.InputNames.allowed_missing_default_select.value}}{{schema_builder.TEMPLATE_SUFFIX}}">&nbsp;Allowed Missing Default</label><br />
                                        <select name="{{schema_builder.InputNames.allowed_missing_default_select.value}}{{schema_builder.TEMPLATE_SUFFIX}}" id="{{schema_builder.InputNames.allowed_missing_default_select.name}}{{schema_builder.TEMPLATE_SUFFIX}}" disabled required>
                                            <option value="">--Select One--</option>
                                            {% for curr_enum in metadata_package_schema_builder.EbiMissingValues %}
                                            <option value="{{curr_enum.name}}" disabled>{{curr_enum.value}}</option>
                                            {% end %}
                                        </select>
                                    </div>
                                    <div class="initially_hidden hidden" id="categorical_default_div_template">
                                        <input type="radio" name="{{schema_builder.InputNames.default_value.value}}{{schema_builder.TEMPLATE_SUFFIX}}" id = "categorical_default_template" value="{{schema_builder.DefaultTypes.categorical_default.name}}">
                                        <label id="categorical_default_label_template" for="{{schema_builder.InputNames.categorical_default_select.value}}{{schema_builder.TEMPLATE_SUFFIX}}">&nbsp;Categorical Default</label><br />
                                        <select name="{{schema_builder.InputNames.categorical_default_select.value}}{{schema_builder.TEMPLATE_SUFFIX}}" id="{{schema_builder.InputNames.categorical_default_select.name}}{{schema_builder.TEMPLATE_SUFFIX}}" disabled required>
                                            <option value="">--Select One--</option>
                                        </select>
                                    </div>
                                    <div class="initially_hidden hidden" id = "continuous_default_div_template">
                                        <input type="radio" name="{{schema_builder.InputNames.default_value.value}}{{schema_builder.TEMPLATE_SUFFIX}}" id = "continuous_default_value_template" value="{{schema_builder.DefaultTypes.continuous_default.name}}">
                                        <label id="continuous_default_label_template" for="{{schema_builder.InputNames.continuous_default.value}}{{schema_builder.TEMPLATE_SUFFIX}}">&nbsp;Continuous Default</label><br />
                                        <input type="text" name="{{schema_builder.InputNames.continuous_default.value}}{{schema_builder.TEMPLATE_SUFFIX}}" id="{{schema_builder.InputNames.continuous_default.name}}{{schema_builder.TEMPLATE_SUFFIX}}" placeholder="e.g., 3" disabled required>
                                    </div>
                                    <div class="initially_hidden hidden" id = "boolean_default_div_template">
                                        <input type="radio" name="{{schema_builder.InputNames.default_value.value}}{{schema_builder.TEMPLATE_SUFFIX}}" id = "boolean_default_value_template" value="{{schema_builder.DefaultTypes.boolean_default.name}}">
                                        <label id="boolean_default_label_template" for="{{schema_builder.InputNames.boolean_default_select.value}}{{schema_builder.TEMPLATE_SUFFIX}}">&nbsp;Boolean Default</label>
                                        <select name="{{schema_builder.InputNames.boolean_default_select.value}}{{schema_builder.TEMPLATE_SUFFIX}}" id="{{schema_builder.InputNames.boolean_default_select.value}}{{schema_builder.TEMPLATE_SUFFIX}}" disabled required>
                                            <option value="">--Select One--</option>
                                        </select>
                                    </div>
                                    <div class="initially_hidden hidden" id = "text_default_div_template">
                                        <input type="radio" name="{{schema_builder.InputNames.default_value.value}}{{schema_builder.TEMPLATE_SUFFIX}}" id = "text_default_value_template" value="{{schema_builder.DefaultTypes.text_default.name}}">
                                        <label id="text_default_label_template" for="{{schema_builder.InputNames.text_default.value}}{{schema_builder.TEMPLATE_SUFFIX}}">&nbsp;Text Default</label><br />
                                        <textarea name="{{schema_builder.InputNames.text_default.value}}{{schema_builder.TEMPLATE_SUFFIX}}" id="{{schema_builder.InputNames.text_default.value}}{{schema_builder.TEMPLATE_SUFFIX}}" placeholder="e.g., 0.5 ml subcutaneously" disabled required></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-12">
                           <input type="button" value="Remove Field" name="remove_field_template" id="remove_field_template">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="row buttons">
            <div class="col-sm-12">
                <input class="submit" type="submit" value="Submit">&nbsp;<input type="button" value="Add Field" id="addField">
            </div>
        </div>
    </div>
</form>
</body>
</html>